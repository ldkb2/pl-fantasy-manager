<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PL Fantasy League Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        body {
            background: linear-gradient(135deg, #1a0a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
        }
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .pulse-glow {
            animation: pulse-glow 2s infinite;
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(56, 189, 248, 0.3); }
            50% { box-shadow: 0 0 40px rgba(56, 189, 248, 0.6); }
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading-dots::after {
            content: '';
            animation: dots 1.5s steps(4, end) infinite;
        }
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
        .difficulty-1, .difficulty-2 { background: #00ff87; color: #1a0a2e; }
        .difficulty-3 { background: #ebebe4; color: #1a0a2e; }
        .difficulty-4 { background: #ff005a; color: white; }
        .difficulty-5 { background: #861d50; color: white; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useCallback, useRef, useEffect } = React;

        // Tab Navigation Component
        function TabNav({ activeTab, setActiveTab, hasAnalysis }) {
            // Only show tabs after analysis is complete
            if (!hasAnalysis) return null;

            const tabs = [
                { id: 'analyze', label: 'Results', icon: 'âš¡' },
                { id: 'upcoming', label: 'Upcoming', icon: 'ðŸ“…' },
                { id: 'chat', label: 'Ask AI', icon: 'ðŸ’¬' },
            ];

            return (
                <div className="flex justify-center gap-2 mb-6">
                    {tabs.map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveTab(tab.id)}
                            className={`px-4 py-2 rounded-full text-sm font-medium transition-all ${
                                activeTab === tab.id
                                    ? 'bg-gradient-to-r from-sky-400 to-purple-500 text-white'
                                    : 'glass text-gray-300 hover:text-white'
                            }`}
                        >
                            {tab.icon} {tab.label}
                        </button>
                    ))}
                </div>
            );
        }

        // Upcoming Fixtures Component
        function UpcomingSection({ fplData }) {
            if (!fplData) {
                return (
                    <div className="text-center py-12">
                        <p className="text-gray-400">Loading fixture data...</p>
                        <button
                            onClick={() => window.location.reload()}
                            className="mt-4 px-4 py-2 glass rounded-full text-white text-sm"
                        >
                            Refresh
                        </button>
                    </div>
                );
            }

            const { currentGameweek, upcomingFixtures, topByForm } = fplData;

            // Group fixtures by gameweek
            const fixturesByGW = {};
            upcomingFixtures.forEach(f => {
                if (!fixturesByGW[f.gameweek]) fixturesByGW[f.gameweek] = [];
                fixturesByGW[f.gameweek].push(f);
            });

            const getDifficultyClass = (diff) => `difficulty-${diff}`;

            return (
                <div className="space-y-6 fade-in">
                    {/* Deadline Banner */}
                    <div className="glass rounded-2xl p-4 text-center">
                        <p className="text-sky-300 text-sm uppercase tracking-wider">Current Gameweek</p>
                        <p className="text-white text-2xl font-bold">{currentGameweek.name}</p>
                        {currentGameweek.deadline && (
                            <p className="text-gray-400 text-sm mt-1">
                                Deadline: {new Date(currentGameweek.deadline).toLocaleString()}
                            </p>
                        )}
                    </div>

                    {/* Fixtures by Gameweek */}
                    {Object.entries(fixturesByGW).slice(0, 3).map(([gw, fixtures]) => (
                        <div key={gw} className="glass rounded-2xl p-4">
                            <h3 className="text-sky-300 text-sm font-medium uppercase tracking-wider mb-3">
                                Gameweek {gw}
                            </h3>
                            <div className="space-y-2">
                                {fixtures.map((f, i) => (
                                    <div key={i} className="flex items-center justify-between text-sm">
                                        <div className="flex items-center gap-2 flex-1">
                                            <span className={`px-2 py-1 rounded text-xs font-bold ${getDifficultyClass(f.homeTeamDifficulty)}`}>
                                                {f.homeTeamDifficulty}
                                            </span>
                                            <span className="text-white">{f.homeTeam}</span>
                                        </div>
                                        <span className="text-gray-500 px-2">vs</span>
                                        <div className="flex items-center gap-2 flex-1 justify-end">
                                            <span className="text-white">{f.awayTeam}</span>
                                            <span className={`px-2 py-1 rounded text-xs font-bold ${getDifficultyClass(f.awayTeamDifficulty)}`}>
                                                {f.awayTeamDifficulty}
                                            </span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    ))}

                    {/* Top Form Players */}
                    <div className="glass rounded-2xl p-4">
                        <h3 className="text-sky-300 text-sm font-medium uppercase tracking-wider mb-3">
                            ðŸ”¥ Top Form Players
                        </h3>
                        <div className="space-y-2">
                            {topByForm.map((p, i) => (
                                <div key={i} className="flex items-center justify-between text-sm">
                                    <div>
                                        <span className="text-white font-medium">{p.name}</span>
                                        <span className="text-gray-400 ml-2">{p.team}</span>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <span className="text-green-400">Form: {p.form}</span>
                                        <span className="text-sky-300">Â£{p.price}m</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Difficulty Legend */}
                    <div className="glass rounded-xl p-3">
                        <p className="text-gray-400 text-xs mb-2 text-center">Fixture Difficulty Rating (FDR)</p>
                        <div className="flex justify-center gap-2">
                            {[1, 2, 3, 4, 5].map(d => (
                                <span key={d} className={`px-2 py-1 rounded text-xs font-bold ${getDifficultyClass(d)}`}>
                                    {d}
                                </span>
                            ))}
                        </div>
                        <p className="text-gray-500 text-xs mt-2 text-center">1-2 = Easy | 3 = Medium | 4-5 = Hard</p>
                    </div>
                </div>
            );
        }

        // Chat Component
        function ChatSection({ analysis, fplData }) {
            const [messages, setMessages] = useState([]);
            const [input, setInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const messagesEndRef = useRef(null);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            useEffect(() => {
                scrollToBottom();
            }, [messages]);

            const sendMessage = async () => {
                if (!input.trim() || isLoading) return;

                const userMessage = input.trim();
                setInput('');
                setMessages(prev => [...prev, { role: 'user', content: userMessage }]);
                setIsLoading(true);

                try {
                    const conversationHistory = messages
                        .map(m => `${m.role === 'user' ? 'User' : 'Assistant'}: ${m.content}`)
                        .join('\n');

                    const response = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            chatMessage: userMessage,
                            previousAnalysis: analysis,
                            conversationHistory
                        })
                    });

                    const data = await response.json();
                    const reply = data.content?.[0]?.text || 'Sorry, I could not process that request.';
                    setMessages(prev => [...prev, { role: 'assistant', content: reply }]);
                } catch (err) {
                    setMessages(prev => [...prev, { role: 'assistant', content: 'Sorry, something went wrong. Please try again.' }]);
                } finally {
                    setIsLoading(false);
                }
            };

            const suggestedQuestions = [
                "Who should I captain this week?",
                "Should I take a hit for a transfer?",
                "Who are the best differentials?",
                "When should I use my wildcard?",
                "Who are the best budget midfielders?"
            ];

            return (
                <div className="space-y-4 fade-in">
                    {/* Chat Messages */}
                    <div className="glass rounded-2xl p-4 min-h-[300px] max-h-[400px] overflow-y-auto">
                        {messages.length === 0 ? (
                            <div className="text-center py-8">
                                <p className="text-gray-400 mb-4">Ask me anything about your FPL team!</p>
                                <div className="flex flex-wrap gap-2 justify-center">
                                    {suggestedQuestions.map((q, i) => (
                                        <button
                                            key={i}
                                            onClick={() => setInput(q)}
                                            className="px-3 py-1 text-xs glass rounded-full text-sky-300 hover:bg-white/10"
                                        >
                                            {q}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-4">
                                {messages.map((msg, i) => (
                                    <div
                                        key={i}
                                        className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}
                                    >
                                        <div
                                            className={`max-w-[85%] rounded-2xl px-4 py-2 ${
                                                msg.role === 'user'
                                                    ? 'bg-gradient-to-r from-sky-400 to-purple-500 text-white'
                                                    : 'glass text-white'
                                            }`}
                                        >
                                            <p className="text-sm whitespace-pre-wrap">{msg.content}</p>
                                        </div>
                                    </div>
                                ))}
                                {isLoading && (
                                    <div className="flex justify-start">
                                        <div className="glass rounded-2xl px-4 py-2">
                                            <p className="text-gray-400 text-sm">Thinking<span className="loading-dots"></span></p>
                                        </div>
                                    </div>
                                )}
                                <div ref={messagesEndRef} />
                            </div>
                        )}
                    </div>

                    {/* Input */}
                    <div className="flex gap-2">
                        <input
                            type="text"
                            value={input}
                            onChange={(e) => setInput(e.target.value)}
                            onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                            placeholder="Ask about your team..."
                            className="flex-1 px-4 py-3 rounded-xl bg-white/10 border border-white/20 text-white placeholder-gray-400 focus:outline-none focus:border-sky-400"
                            disabled={isLoading}
                        />
                        <button
                            onClick={sendMessage}
                            disabled={isLoading || !input.trim()}
                            className="px-4 py-3 rounded-xl bg-gradient-to-r from-sky-400 to-purple-500 text-white font-medium disabled:opacity-50"
                        >
                            Send
                        </button>
                    </div>
                </div>
            );
        }

        // Upload Component
        function ImageUploader({ label, icon, onImageSelect, preview, isProcessing }) {
            const [dragActive, setDragActive] = useState(false);
            const inputRef = useRef(null);

            const handleDrag = useCallback((e) => {
                e.preventDefault();
                e.stopPropagation();
                if (e.type === "dragenter" || e.type === "dragover") {
                    setDragActive(true);
                } else if (e.type === "dragleave") {
                    setDragActive(false);
                }
            }, []);

            const processFile = useCallback((file) => {
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => onImageSelect(e.target.result);
                    reader.readAsDataURL(file);
                }
            }, [onImageSelect]);

            const handleDrop = useCallback((e) => {
                e.preventDefault();
                e.stopPropagation();
                setDragActive(false);
                if (e.dataTransfer.files?.[0]) processFile(e.dataTransfer.files[0]);
            }, [processFile]);

            const handleChange = useCallback((e) => {
                if (e.target.files?.[0]) processFile(e.target.files[0]);
            }, [processFile]);

            return (
                <div className="w-full">
                    <label className="block text-sky-300 text-sm font-medium mb-2 text-center">{label}</label>
                    <div
                        className={`relative rounded-2xl p-4 text-center cursor-pointer transition-all duration-300 ${
                            dragActive ? 'glass border-sky-400 scale-105' : 'glass hover:border-sky-400/50'
                        } ${isProcessing ? 'opacity-50 pointer-events-none' : ''}`}
                        onDragEnter={handleDrag}
                        onDragLeave={handleDrag}
                        onDragOver={handleDrag}
                        onDrop={handleDrop}
                        onClick={() => inputRef.current?.click()}
                    >
                        <input ref={inputRef} type="file" accept="image/*" onChange={handleChange} className="hidden" />
                        {preview ? (
                            <div className="fade-in">
                                <img src={preview} alt={label} className="w-full h-32 object-contain rounded-lg mb-2" />
                                <p className="text-green-400 text-xs flex items-center justify-center gap-1">
                                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
                                    </svg>
                                    Uploaded
                                </p>
                            </div>
                        ) : (
                            <>
                                <div className="w-12 h-12 mx-auto mb-2 rounded-full bg-gradient-to-r from-sky-400 to-purple-500 flex items-center justify-center">
                                    {icon}
                                </div>
                                <p className="text-white font-medium text-sm mb-1">Upload screenshot</p>
                                <p className="text-gray-400 text-xs">Drag & drop or tap</p>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        // Loading Component
        function LoadingState() {
            return (
                <div className="w-full max-w-md mx-auto text-center py-12 fade-in">
                    <div className="w-20 h-20 mx-auto mb-6 rounded-full bg-gradient-to-r from-sky-400 to-purple-500 pulse-glow flex items-center justify-center">
                        <svg className="w-10 h-10 text-white animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                            <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                    <h3 className="text-white text-xl font-semibold mb-2">Analyzing your team<span className="loading-dots"></span></h3>
                    <p className="text-gray-400">Fetching live data and generating recommendations</p>
                </div>
            );
        }

        // Player Card Component with color-coded backgrounds and expandable pundit info
        function PlayerCard({ player, action, reason }) {
            const [expanded, setExpanded] = useState(false);
            const [punditInfo, setPunditInfo] = useState(null);
            const [loadingPundit, setLoadingPundit] = useState(false);

            // Background colors: green=keep, orange=consider, red=change
            const cardStyles = {
                'keep': 'bg-green-500/20 border-green-500/50',
                'bench': 'bg-orange-500/20 border-orange-500/50',
                'sell': 'bg-red-500/20 border-red-500/50',
                'captain': 'bg-purple-500/20 border-purple-500/50',
                'vice-captain': 'bg-blue-500/20 border-blue-500/50'
            };
            const textColors = {
                'keep': 'text-green-400',
                'bench': 'text-orange-400',
                'sell': 'text-red-400',
                'captain': 'text-purple-400',
                'vice-captain': 'text-blue-400'
            };
            const actionLabels = {
                'keep': 'âœ“ KEEP',
                'bench': 'âš  CONSIDER',
                'sell': 'âœ• CHANGE',
                'captain': 'C CAPTAIN',
                'vice-captain': 'V VICE'
            };

            const fetchPunditInfo = async () => {
                if (punditInfo) {
                    setExpanded(!expanded);
                    return;
                }
                setExpanded(true);
                setLoadingPundit(true);
                try {
                    const response = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            playerLookup: player
                        })
                    });
                    const data = await response.json();
                    const info = data.content?.[0]?.text || 'No pundit information available.';
                    setPunditInfo(info);
                } catch (err) {
                    setPunditInfo('Unable to fetch pundit information.');
                } finally {
                    setLoadingPundit(false);
                }
            };

            return (
                <div className={`rounded-xl p-4 fade-in border ${cardStyles[action] || 'bg-gray-500/20 border-gray-500/50'}`}>
                    <div className="flex items-start justify-between">
                        <div className="flex-1">
                            <div className="flex items-center justify-between mb-2">
                                <h4 className="text-white font-semibold text-lg">{player}</h4>
                                <div className="flex items-center gap-2">
                                    <span className={`text-xs font-bold px-2 py-1 rounded ${textColors[action] || 'text-gray-400'}`}>
                                        {actionLabels[action] || action?.toUpperCase()}
                                    </span>
                                    <button
                                        onClick={fetchPunditInfo}
                                        className="text-sky-400 hover:text-sky-300 transition-colors"
                                        title="View pundit opinions"
                                    >
                                        <svg className={`w-5 h-5 transition-transform ${expanded ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <p className="text-gray-300 text-sm">{reason}</p>

                            {/* Expandable pundit section */}
                            {expanded && (
                                <div className="mt-3 pt-3 border-t border-white/10">
                                    <p className="text-sky-300 text-xs font-medium uppercase tracking-wider mb-2">ðŸ“° Scout & Pundit Intel</p>
                                    {loadingPundit ? (
                                        <p className="text-gray-400 text-sm">Fetching latest opinions<span className="loading-dots"></span></p>
                                    ) : (
                                        <div className="text-gray-300 text-sm whitespace-pre-wrap">{punditInfo}</div>
                                    )}
                                    <div className="mt-2 flex flex-wrap gap-2">
                                        <a
                                            href={`https://www.google.com/search?q=${encodeURIComponent(player + ' FPL scout analysis 2024')}`}
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            className="text-xs text-sky-400 hover:text-sky-300 underline"
                                        >
                                            Google Search
                                        </a>
                                        <a
                                            href={`https://twitter.com/search?q=${encodeURIComponent(player + ' FPL')}&f=live`}
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            className="text-xs text-sky-400 hover:text-sky-300 underline"
                                        >
                                            Twitter/X
                                        </a>
                                        <a
                                            href={`https://www.reddit.com/r/FantasyPL/search/?q=${encodeURIComponent(player)}&sort=new`}
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            className="text-xs text-sky-400 hover:text-sky-300 underline"
                                        >
                                            r/FantasyPL
                                        </a>
                                        <a
                                            href={`https://www.fantasyfootballscout.co.uk/?s=${encodeURIComponent(player)}`}
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            className="text-xs text-sky-400 hover:text-sky-300 underline"
                                        >
                                            FF Scout
                                        </a>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        }

        // Transfer Card Component
        function TransferCard({ playerOut, playerIn, outPrice, inPrice, reason }) {
            return (
                <div className="glass rounded-xl p-4 fade-in">
                    <div className="flex items-center justify-between mb-3">
                        <div className="flex items-center gap-2">
                            <span className="w-8 h-8 rounded-full bg-red-500/20 text-red-400 flex items-center justify-center text-sm font-bold">OUT</span>
                            <div>
                                <span className="text-white font-medium">{playerOut}</span>
                                {outPrice && <span className="text-red-400 text-xs ml-2">{outPrice}</span>}
                            </div>
                        </div>
                        <svg className="w-6 h-6 text-sky-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7l5 5m0 0l-5 5m5-5H6" />
                        </svg>
                        <div className="flex items-center gap-2">
                            <div className="text-right">
                                <span className="text-white font-medium">{playerIn}</span>
                                {inPrice && <span className="text-green-400 text-xs ml-2">{inPrice}</span>}
                            </div>
                            <span className="w-8 h-8 rounded-full bg-green-500/20 text-green-400 flex items-center justify-center text-sm font-bold">IN</span>
                        </div>
                    </div>
                    <p className="text-gray-400 text-sm">{reason}</p>
                </div>
            );
        }

        // Results Component
        function Results({ analysis }) {
            if (!analysis) return null;

            return (
                <div className="w-full max-w-md mx-auto space-y-6 fade-in">
                    <div className="glass rounded-2xl p-6">
                        <h3 className="text-sky-300 text-sm font-medium uppercase tracking-wider mb-2">Team Analysis</h3>
                        <p className="text-white">{analysis.summary}</p>
                    </div>

                    {analysis.formation && (
                        <div className="glass rounded-2xl p-6">
                            <h3 className="text-sky-300 text-sm font-medium uppercase tracking-wider mb-4">Recommended Setup</h3>
                            <div className="flex items-center justify-center gap-4 mb-4">
                                <span className="text-4xl font-bold bg-gradient-to-r from-sky-400 to-purple-500 bg-clip-text text-transparent">
                                    {analysis.formation}
                                </span>
                            </div>
                            <p className="text-gray-400 text-sm text-center">{analysis.formationReason}</p>
                        </div>
                    )}

                    {analysis.captainPicks?.length > 0 && (
                        <div className="glass rounded-2xl p-6">
                            <h3 className="text-sky-300 text-sm font-medium uppercase tracking-wider mb-4">Captain Picks</h3>
                            <div className="space-y-3">
                                {analysis.captainPicks.map((pick, i) => (
                                    <PlayerCard key={i} player={pick.player} action={pick.role} reason={pick.reason} />
                                ))}
                            </div>
                        </div>
                    )}

                    {analysis.lineup?.length > 0 && (
                        <div className="glass rounded-2xl p-6">
                            <h3 className="text-sky-300 text-sm font-medium uppercase tracking-wider mb-4">Starting XI Notes</h3>
                            <div className="space-y-3">
                                {analysis.lineup.map((player, i) => (
                                    <PlayerCard key={i} player={player.player} action={player.action} reason={player.reason} />
                                ))}
                            </div>
                        </div>
                    )}

                    {analysis.transfers?.length > 0 && (
                        <div className="glass rounded-2xl p-6">
                            <h3 className="text-sky-300 text-sm font-medium uppercase tracking-wider mb-4">Transfer Suggestions</h3>
                            <div className="space-y-4">
                                {analysis.transfers.map((transfer, i) => (
                                    <TransferCard
                                        key={i}
                                        playerOut={transfer.out}
                                        playerIn={transfer.in}
                                        outPrice={transfer.outPrice}
                                        inPrice={transfer.inPrice}
                                        reason={transfer.reason}
                                    />
                                ))}
                            </div>
                        </div>
                    )}

                    {analysis.chipAdvice && (
                        <div className="glass rounded-2xl p-6">
                            <h3 className="text-sky-300 text-sm font-medium uppercase tracking-wider mb-2">Chip Strategy</h3>
                            <p className="text-white">{analysis.chipAdvice}</p>
                        </div>
                    )}

                    {analysis.punditView && (
                        <div className="glass rounded-2xl p-6">
                            <h3 className="text-sky-300 text-sm font-medium uppercase tracking-wider mb-2">ðŸ“º Expert View</h3>
                            <p className="text-white">{analysis.punditView}</p>
                        </div>
                    )}
                </div>
            );
        }

        // Error Component
        function ErrorDisplay({ message, onRetry }) {
            return (
                <div className="w-full max-w-md mx-auto text-center py-8 fade-in">
                    <div className="w-16 h-16 mx-auto mb-4 rounded-full bg-red-500/20 flex items-center justify-center">
                        <svg className="w-8 h-8 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <h3 className="text-white text-lg font-semibold mb-2">Something went wrong</h3>
                    <p className="text-gray-400 mb-4">{message}</p>
                    <button onClick={onRetry} className="px-6 py-2 rounded-full bg-gradient-to-r from-sky-400 to-purple-500 text-white font-medium">
                        Try Again
                    </button>
                </div>
            );
        }

        // Main App Component
        function App() {
            const [activeTab, setActiveTab] = useState('analyze');
            const [pickTeamImage, setPickTeamImage] = useState(null);
            const [transfersImage, setTransfersImage] = useState(null);
            const [isProcessing, setIsProcessing] = useState(false);
            const [analysis, setAnalysis] = useState(null);
            const [fplData, setFplData] = useState(null);
            const [error, setError] = useState(null);

            const canAnalyze = pickTeamImage && transfersImage;

            // Fetch FPL data on mount for Upcoming tab
            useEffect(() => {
                const fetchData = async () => {
                    try {
                        const res = await fetch('https://fantasy.premierleague.com/api/bootstrap-static/');
                        const bootstrap = await res.json();
                        const fixturesRes = await fetch('https://fantasy.premierleague.com/api/fixtures/');
                        const fixtures = await fixturesRes.json();

                        const currentGW = bootstrap.events.find(e => e.is_current) || bootstrap.events.find(e => e.is_next);
                        const teams = {};
                        bootstrap.teams.forEach(t => { teams[t.id] = t.name; });

                        const upcoming = fixtures
                            .filter(f => f.event >= currentGW?.id && f.event <= currentGW?.id + 5)
                            .map(f => ({
                                gameweek: f.event,
                                homeTeam: teams[f.team_h],
                                awayTeam: teams[f.team_a],
                                homeTeamDifficulty: f.team_h_difficulty,
                                awayTeamDifficulty: f.team_a_difficulty,
                                kickoffTime: f.kickoff_time
                            }));

                        const players = bootstrap.elements.map(p => ({
                            name: p.web_name,
                            team: teams[p.team],
                            price: p.now_cost / 10,
                            form: parseFloat(p.form),
                            minutes: p.minutes
                        }));

                        const topByForm = [...players]
                            .filter(p => p.minutes > 200)
                            .sort((a, b) => b.form - a.form)
                            .slice(0, 10);

                        setFplData({
                            currentGameweek: {
                                id: currentGW?.id,
                                name: currentGW?.name,
                                deadline: currentGW?.deadline_time
                            },
                            upcomingFixtures: upcoming,
                            topByForm
                        });
                    } catch (err) {
                        console.error('Failed to fetch FPL data:', err);
                    }
                };
                fetchData();
            }, []);

            const analyzeTeam = async () => {
                if (!canAnalyze) return;
                setIsProcessing(true);
                setError(null);
                setAnalysis(null);

                try {
                    const pickTeamBase64 = pickTeamImage.split(',')[1];
                    const pickTeamMediaType = pickTeamImage.split(';')[0].split(':')[1];
                    const transfersBase64 = transfersImage.split(',')[1];
                    const transfersMediaType = transfersImage.split(';')[0].split(':')[1];

                    const response = await fetch('/api/analyze', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            pickTeamImage: pickTeamBase64,
                            pickTeamMediaType,
                            transfersImage: transfersBase64,
                            transfersMediaType
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || `API error: ${response.status}`);
                    }

                    const data = await response.json();

                    // Update FPL data from response
                    if (data.fplData) {
                        setFplData(data.fplData);
                    }

                    const content = data.content[0].text;
                    const jsonMatch = content.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        setAnalysis(JSON.parse(jsonMatch[0]));
                    } else {
                        setAnalysis({ summary: content });
                    }
                } catch (err) {
                    setError(err.message || 'Failed to analyze team.');
                } finally {
                    setIsProcessing(false);
                }
            };

            const handleReset = () => {
                setPickTeamImage(null);
                setTransfersImage(null);
                setAnalysis(null);
                setError(null);
                setActiveTab('analyze');
            };

            const pickTeamIcon = (
                <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
            );

            const transfersIcon = (
                <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                </svg>
            );

            return (
                <div className="min-h-screen py-8 px-4">
                    <header className="text-center mb-6">
                        <div className="inline-flex items-center justify-center w-14 h-14 rounded-2xl bg-gradient-to-r from-sky-400 to-purple-500 mb-3">
                            <svg className="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                        </div>
                        <h1 className="text-xl font-bold text-white mb-1">PL Fantasy League Manager</h1>
                    </header>

                    <main className="max-w-md mx-auto">
                        {/* Clean landing page - upload section */}
                        {!analysis && !isProcessing && (
                            <div className="space-y-6 fade-in">
                                <p className="text-center text-gray-300 text-sm">Upload screenshots from your FPL app</p>
                                <div className="grid grid-cols-2 gap-4">
                                    <ImageUploader label="Pick Team" icon={pickTeamIcon} onImageSelect={setPickTeamImage} preview={pickTeamImage} isProcessing={isProcessing} />
                                    <ImageUploader label="Transfers" icon={transfersIcon} onImageSelect={setTransfersImage} preview={transfersImage} isProcessing={isProcessing} />
                                </div>
                                <div className="text-center">
                                    <button
                                        onClick={analyzeTeam}
                                        disabled={!canAnalyze}
                                        className={`px-8 py-4 rounded-full font-semibold text-lg transition-all ${
                                            canAnalyze
                                                ? 'bg-gradient-to-r from-sky-400 to-purple-500 text-white hover:scale-105'
                                                : 'bg-gray-600 text-gray-400 cursor-not-allowed'
                                        }`}
                                    >
                                        {canAnalyze ? 'Analyze My Team' : 'Upload Both Screenshots'}
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* Loading state */}
                        {isProcessing && <LoadingState />}

                        {/* Error state */}
                        {error && !analysis && <ErrorDisplay message={error} onRetry={() => setError(null)} />}

                        {/* Results phase - with tabs */}
                        {analysis && (
                            <div className="space-y-6">
                                <TabNav activeTab={activeTab} setActiveTab={setActiveTab} hasAnalysis={!!analysis} />

                                {activeTab === 'analyze' && <Results analysis={analysis} />}
                                {activeTab === 'upcoming' && <UpcomingSection fplData={fplData} />}
                                {activeTab === 'chat' && <ChatSection analysis={analysis} fplData={fplData} />}

                                <div className="text-center pt-4">
                                    <button onClick={handleReset} className="px-6 py-2 rounded-full glass text-white font-medium hover:bg-white/20">
                                        Analyze Another Team
                                    </button>
                                </div>
                            </div>
                        )}
                    </main>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
